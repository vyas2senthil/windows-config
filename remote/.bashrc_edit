#!/bin/bash
export LOCALIP=`echo $SSH_CONNECTION|awk '{print $3}'|sed -e 's/.*://'`
export WHOAMI=`whoami`
export REMOTEIP=`echo ${SSH_CLIENT} | awk '{print $1}'|perl -npe 's/.*://'`
function work_dir_view() 
{
    if [[ $HAS_CLEARCASE == true ]]; then
        if cleartool pwv -short -wdview|grep NONE >/dev/null; then
            ROOT_PATH=;
        else
            ROOT_PATH=/view/`cleartool pwv -short -setview`;
        fi
    else
        ROOT_PATH=;
    fi
    echo $ROOT_PATH
}

function edit()
{
    if [[ $WHOAMI == root ]] && [[ -f "$1" ]]; then
        echo using root to do edit, won\'t check read permission
    else
        if ! [[ -r "$1" ]]; then
            echo Error: "$1" is not readable
            return 1
        fi
        if ! [[ -w "$1" ]]; then
            echo Warning: "$1" is not writable
        fi
    fi    
    local IFS=$'\n'
    local file=$( readlink -f "$1" )
    local dir=$( dirname "$file" )
    file=$( basename "$file")
    cd "$dir" >/dev/null 2>&1

    ssh $REMOTEIP /qq/bin/windows/rsshedit.sh $wait_for_emacs \""/scp:$WHOAMI@$LOCALIP:`work_dir_view`/`pwd`/$file"\"
    cd - >/dev/null 2>&1
}

alias sudoedit='WHOAMI=root edit'
