#!/bin/bash


run_dir=$(basename $1)

export USER=$(whoami) #in cron daemon, this env variable is not set by default.
export RUNNING_IN_CRON=true

logdir=~/.logs/cron-log/$run_dir
mkdir -p $logdir

exec > $logdir/bhj-cron-runner 2>&1
set -e
set -x

function die() {
    echo "$@"
    exit -1
}

cd ~/etc/cron.d/$run_dir
cmds=($(find . -maxdepth 1 -type f -o -type l|grep -v -e '\.stackdump$'))

for x in ${cmds[@]}; do
    chmod +x $x || true
    test -e $x || continue
    ld=$logdir/$x/$(date +%A)/
    mkdir -p $ld
    ($x || bhj-notify cron-runner "$x failed" &) > $ld/$(date +%H:%M) 2>&1 
done&
