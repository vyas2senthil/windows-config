#!/bin/bash

if test $# = 1; then
    set -- "$@" .
fi

args=("$@")
n_targets=$#
((n_targets--))

last_arg=${args[$#-1]}

function die() {
    echo "$@"
    exit -1
}

function calc_relative() {
    source=$1
    target=$2/

    source=$(echo "$source"|perl -npe 's,/+,/,g')
    source=$(lookup_file "$source")

    while [[ "$source" =~ /./ ]]; do
	source=$(echo "$source" | perl -npe 's,/\./,/,g')
    done

    while [[ "$source" =~ /../ ]]; do
	source=$(echo "$source" | perl -npe 's,(^|[^/]+)/\.\./,/,g')
    done

    perl -e '
($s, $t)  = @ARGV;
@s = split("", $s);
@t = split("", $t);

$n = 0;
$last_slash = 0;
while (@s and @t) {
    if ($s[0] eq $t[0]) {
        $n ++;
        $last_slash = $n if $s[0] eq "/";
        shift @s;
        shift @t;
    } else {
        last;
    }
}

$relative_s = substr($s, $last_slash);
$remaining_t = substr($t, $last_slash);

$remaining_t = grep(m:/:, split("", $remaining_t));
$relative_s = "../" x $remaining_t . $relative_s;
print "$relative_s";
' "$source" "$target"
}

last_arg=$(readlink -f "$last_arg")
if (($# > 2)) && test ! -d "$last_arg"; then
    die "ln: target \`Android.mk' is not a directory"
fi

test -f "$last_arg" && last_arg=$(dirname "$last_arg")
test -e "$last_arg" || die "ln: target \`$last_arg does not exist"

for x in $(seq 1 $n_targets); do
    source=${args[$x-1]}
    relative_source=$(calc_relative "$source" "$last_arg")
    ln -s -- "$relative_source" "$last_arg"/
done
    
