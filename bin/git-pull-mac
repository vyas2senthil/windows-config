#!/bin/bash

set -e
test $PWD = ~ && cd ~/windows-config/
cd "$(dirname "$(lookup_file .git)")"

git-clean-mac-branches-local
git config remote.origin.url $(git config remote.origin.url | perl -npe 's,^git://,https://,')
git fetch origin >/dev/null 2>&1 
for x in $(git branch -a |grep 'remotes.*from-mac'|grep -v origin-w); do
    remote=$(echo $x|awk -F/ '{print $2}')
    branch=$(echo $x|perl -npe 's/.*?from-mac/from-mac/')
    git fetch $remote $branch >/dev/null 2>&1 
    if git branch --contains FETCH_HEAD |grep -q '^\*'; then
	echo no need to merge $branch, it is already '*contained*' in HEAD
	continue;
    else
	current=$(git log -1|head -n 1|pn 2)
	git merge FETCH_HEAD >/dev/null 2>&1 || {
	    echo $remote/$branch merge failed
	    exit -1
	}
	if git diff --quiet $current; then
	    echo $remote/$branch contains no diff after merge, reset it
	    git reset --hard $current
	else
	    echo merged from $branch
	    continue
	fi
    fi
done
if test "$USER" = bhj; then
    crontab ~/.crontab
fi
git submodule init
git submodule update
git submodule foreach 'bash -c "git-pull-mac&"' | grep .
fix-submodule-dot-git
~/bin/after-co-ln-s.sh
touch ~/windows-config/.for-code-reading
