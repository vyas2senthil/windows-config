#!/bin/bash

function die() {
    echo "$@"
    exit -1
}


time=$(now 2>/dev/null -d "$1" | perl -npe 's/(.*)-.*/$1-00:00:01/')

if test -z "$time"; then
    die "Error: Usage $(basename $0) ['n day ago']"
fi

echo "Will roll back to $time"
export ROLLBACK_TIME=$time

export ANDROID_DIR=$(lookup_file .repo/..)
cd $ANDROID_DIR

set -e
test -d .repo

exec 9>.android-full-build.lock
flock 9

rm .repo/repo_info.pl -f
my-rfa '
if test $(basename $PWD) = tcmd; then
    exit 0
fi
set -x
commit=$(git log --format=fuller --until="$ROLLBACK_TIME" $(repo-remote-branch) -1|head -n 1 | pn 2);
git reset --hard $commit;
git clean -xfd;
'

my-rfa '
if test -e $ANDROID_DIR/flashing/quilt/$(repo-path); then
    commit=$(git log --format=fuller --until="$ROLLBACK_TIME" $(repo-remote-branch) -1|head -n 1 | pn 2);
    export GQ_REBASE_TO=$commit
    bpe-update -r
fi
'
