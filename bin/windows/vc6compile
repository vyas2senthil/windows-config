#!/bin/bash

function get_first_project() 
{
    get_all_projects "$1"|head -n 1
}

function get_all_projects()
{
    cat "$1"|grep '^Project: '|awk -F\" '{print $2}'
}

function msdev()
{
    if [[ $2 != /make ]]; then
        echo "Error: arg 2 must be /make"
        exit
    fi

    if [[ -z "$3" ]]
    then
        project="`get_first_project $1`"
    elif [[ "$3" == all ]]
    then
        project="`get_all_projects $1`"
    else
        project="$3"
    fi

    if [[ -z "$4" ]]
    then
        config=release
    elif [[ "$4" == all ]]
    then
        config="release debug"
    else
        config="$4"
    fi

    dsw_file="$1"
    shift #get rid of dsw_file
    shift #get rid of /make
    shift #get rid of project
    shift #get rid of config
    
    #the remaining args could be like `/clean'
    for p in $project; do
        for c in $config; do
            echo "compiling project \`$p' with config \`$c' in \`$dsw_file'"
            command msdev "$dsw_file" /make "$p - win32 $c" "$@"
        done
    done    
}

if ls *.dsw > /dev/null 2>&1
then
    msdev ./*.dsw /make "$@" 
elif ls ../*.dsw > /dev/null 2>&1
then
    msdev ../*.dsw /make "$@"
elif ls ../../*.dsw > /dev/null 2>&1
then
    msdev ../../*.dsw /make "$@"
fi
