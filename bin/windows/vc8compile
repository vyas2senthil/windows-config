#!/bin/bash

#!/bin/bash

function get_first_project() 
{
    get_all_projects "$1"|head -n 1
}

function get_all_projects()
{
    cat "$1"|grep '^Project.*='|awk -F\" '{print $4}'
}

function print_project_dir()
{
    awk -F \" '$4 == '$2'{print $6}' < $1
}
function msdev()
{
    sln_file="$1"
    sln_dir="`basename \"$1\"`"
    if [[ -z "$2" ]]
    then
        project="`get_first_project $sln_file`"
    elif [[ "$2" == all ]]
    then
        project="`get_all_projects $sln_file`"
    else
        project="$2"
    fi

    if [[ -z "$3" ]]
    then
        config=release
    elif [[ "$3" == all ]]
    then
        config="release debug"
    else
        config="$3"
    fi


    shift #get rid of sln_file
    shift #get rid of project
    shift #get rid of config

    local cmd
    if [[ -z "$1" ]]
    then
        cmd=/Build
    else 
        cmd="$1"
        shift #it could be /Clean        
    fi
    
    #the remaining args could be like `/clean'
    for p in $project; do
        print_project_dir $sln_file $project #for Emacs, echo make: Entering directory `C:/src/alchemy/JSC-vc8/AlchemyLib'
        for c in $config; do
            echo "compiling project \`$p' with config \`$c' in \`$sln_file'"
            vc8.com "$sln_file" /Project $p "$cmd" $c "$@"
        done
    done    
}

if ls *.sln > /dev/null 2>&1
then
    msdev ./*.sln  "$@" 
elif ls ../*.sln > /dev/null 2>&1
then
    msdev ../*.sln  "$@"
elif ls ../../*.sln > /dev/null 2>&1
then
    msdev ../../*.sln  "$@"
fi
