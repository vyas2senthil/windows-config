#!/bin/bash
set -e

cd ~/confluence/
IFS=$'\n'
args=("$@")
if test $# = 0; then
    args=($(git-st-s-utf8|grep -e '\.org$'))
fi
for x in "${args}"; do
    org-to-mht "$x"
    (
        bash ~/doc/confluence-head "$x"
        cat -- "$x"
        cat ~/doc/confluence-tail;
    ) > "$x".$$

    congfu -- -a storePage --title "${x%%.org}" --encoding UTF-8 --file "$x".$$ || die "Error: see above"
    congfu -- -a removeAttachment  --title "${x%%.org}" --name "$x".mht
    congfu -- -a addAttachment --title "${x%%.org}" --file "$x".mht --mime text/html
    rm "$x".$$
done

