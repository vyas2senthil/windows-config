#!/bin/bash
function config_email()
{
    #config .gnus
    read -p 'Please input your gmail account (for e.g., somebody@gmail.com): ' Gmail

    perl -npe 's/baohaojun@gmail.com/'$Gmail'/g' -i ~/.gnus

    #config smtp:
    read -s -p 'Please input your gmail password: ' Gpass
    cat <<EOF >~/.postfix.cf


################################################################
relayhost = [smtp.gmail.com]:587
default_transport = smtp
relay_transport = smtp
inet_protocols = ipv4
smtp_sasl_auth_enable=yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_passwd
smtp_use_tls = yes
smtp_sasl_security_options = noanonymous
smtp_sasl_tls_security_options = noanonymous
smtp_tls_note_starttls_offer = yes
tls_random_source = dev:/dev/urandom
smtp_tls_scert_verifydepth = 5
smtpd_tls_ask_ccert = yes
smtpd_tls_req_ccert =no
smtp_tls_enforce_peername = no
EOF
    sudo bash -c "cat ~/.postfix.cf >>/etc/postfix/main.cf"
    sudo bash -c "echo '[smtp.gmail.com]:587' $Gmail:$Gpass > /etc/postfix/sasl_passwd"
    cd /etc/postfix/
    sudo postmap sasl_passwd
    sudo postfix reload

#config dovecot
#先把这些配置内容放到我自己有写权限的文件里去，下面再用sudo bash -c搞到/etc/dovecot/dovecot.conf里。
#上面的postfix/main.cf也是这样做的。

cat <<EOF > ~/.dovecot
protocols = imap imaps
log_timestamp = "%Y-%m-%d %H:%M:%S "
   mail_location = maildir:~/Maildir
mail_privileged_group = mail
protocol imap {
}
  
protocol pop3 {
  pop3_uidl_format = %08Xu%08Xv
}
protocol managesieve {
}
auth default {
  mechanisms = plain
  passdb pam {
  }
  userdb passwd {
  }
  user = root
}
dict {
}
plugin {
}
EOF

    sudo bash -c "cat ~/.dovecot > /etc/dovecot/dovecot.conf"


# 配置offlineimap
    read -p "Please input your password of this PC: " lpass
    cat <<EOF > ~/.offlineimaprc
[general]
accounts = Gmail
maxsyncaccounts = 1

ui = Noninteractive.Basic, Noninteractive.Quiet

[Account Gmail]
localrepository = Local
remoterepository = Remote

[Repository Local]
type = IMAP
remotehost = localhost
port = 143
remoteuser = `whoami`
remotepass = $lpass

[Repository Remote]
type = IMAP
remotehost = imap.gmail.com
remoteuser = $Gmail
remotepass = $Gpass
ssl = yes
maxconnections = 1
realdelete = no
folderfilter = lambda foldername: all([x.lower() not in foldername.lower() for x in ('all mail', 'spam', 'trash')])

EOF

    sudo /etc/init.d/dovecot restart
    offlineimap
#now you should be able to start gnus in Emacs
}

read -p 'Do you want to configure your Gmail? [y/N]: ' Want

if test "$Want" = "Y" -o "$Want" = "y"
then
    echo "OK. Configure email"
    config_email
else
    echo "OK. Not configure email"
fi
