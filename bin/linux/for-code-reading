#!/bin/bash

Filter=${Filter:-~/.my-beagle-filter-android}
SrcReadingDir=~/tmp/for-code-reading/"`pwd`"

function mkcscope_files() {
    find \( '-path' '*/CVS' \
        '-o' '-path' '*/.svn' \
        '-o' '-path' '*/autom4te.cache' \
        '-o' '-path' '*/{arch}' \
        '-o' '-path' '*/.hg' \
        '-o' '-path' '*/_darcs' \
        '-o' '-path' '*/.git' \
        '-o' '-path' '*/.bzr' \
        '-o' '-path' '*~*' \
        '-o' '-path' '*#' \
        '-o' '-path' '*/TAGS' \
        '-o' '-path' '*/tags' \
        '-o' '-path' '*/semantic.cache' \
        '-o' '-path' './out' \
        '-o' '-iname' '*.o' \
        '-o' '-iname' '*.class' \
        '-o' '-iname' '*.obj' \
        '-o' '-iname' '*.pyc' \
        '-o' '-iname' '*.elc' \
        '-o' '-path' '*/.ignore' \
        '-o' '-path' '*/.repo' \
        '-o' '-iname' "cscope.files" \
        -o -iname "cscope.out" \
        -o -ipath "*/.beagle" \
        \) -prune -o -type f -print0|xargs -0 grep . -Il|$Filter | tee "$SrcReadingDir"/cscope.files
}

function _mk_help_dir() {
    mkdir -p "$SrcReadingDir"
}

function mkgtags() {
    _mk_help_dir
    mkcscope_files | gtags --gtagslabel=plugin-example -f - "$@" "$SrcReadingDir"
}

function mkgtags-filter() {
    gtags --gtagslabel=plugin-example -f - "$@" "$SrcReadingDir"
}

function mkbeagleidx() {
    mkdir -p "$SrcReadingDir"/.beagle
    beagle-build-index --recursive --deny-directory-pattern `pwd`/out --enable-deletion --target "$SrcReadingDir"/.beagle/ .
    ln $Filter "$SrcReadingDir"/.beagle-filter -sf
}

function for-code-reading() {
    mkgtags "$@"&
    mkbeagleidx "$@"&
}

`basename $0` "$@"
