#!/bin/bash

set -- $(
    for x in "$@"; do
	echo -d "$x"
    done
)

my-rfa -j 4 "$@" -- '
set -- $($REPO_INFO remote branch path)
remote=$1
branch=$2
path=$3
rev=$(git show -s --format=format:"%H" $remote/$branch)

if test $(git show -s --format=format:"%H" HEAD) != $rev; then
    git fetch $remote $branch >/dev/null 2>&1
    rev=$(git show -s --format=format:"%H" FETCH_HEAD)
    if test $(git log -1 --pretty=oneline|pn 1) != $rev; then
        (
            flock -x 9;
            echo $path;
            exit
        )
    fi
fi

if git status -s |grep -q .; then
    (
        flock -x 9;
        echo $path;
    )
fi' 2>&1 9>~/.logs/repo-changes.lock | (
    cd $(lookup_file .repo/..);
    log=./out/repo-changes.log"$(echo -n $*)"
    lognow="$log-$(now)"
    tee "$lognow" 2>/dev/null
    ln -sf $(basename "$lognow") "$log" >/dev/null 2>&1
)
