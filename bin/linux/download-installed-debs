#!/bin/bash

set -e

workdir=~/external/installed-pkgs/pkgs
mkdir -p $workdir

cd $workdir
grep-status -P -e '.*' -a -FStatus 'install ok installed' -n -s Package|xargs touch

export PACKAGES_DIR=$workdir

cd ..

install-pkgs -s --reinstall >pkgs.txt 2>&1 

sites=mirrors.163.com/debian
releases=testing\ unstable
dists=main\ contrib\ non-free
archs=amd64\ i386

for site in $sites; do
    for release in $releases; do
	for dist in $dists; do
	    for arch in $archs; do
		echo http://$site/dists/$release/$dist/binary-$arch/Packages.bz2
	    done
	done
    done
done | mf-download.pl -n 5
	
	
testing=$(cat pkgs.txt|grep -e '^Inst .*Debian:testing'|pn 2)
unstable=$(cat pkgs.txt|grep -e '^Inst .*Debian:unstable'|pn 2)

rm -f testing.pkgs unstable.pkgs

for site in $sites; do
    export SITE=$site
    for release in $releases; do
	for dist in $dists; do
	    for arch in $archs; do
		bzcat $site/dists/$release/$dist/binary-$arch/Packages.bz2 | get-deb-pkg-path $(eval echo \$$release) >> $release.pkgs
	    done
	done
    done
done

(
    cat testing.pkgs; 
    cat unstable.pkgs;
) | grep '^Y: ' | pn 2 | sort -u | mf-download.pl -n 5

mkdir -p debs
rm debs/*
echo 'cat *.pkgs | pn 2 | sort -u | xargs -I %s relative-link %s ./debs/'|putclip
