#!/bin/bash

set -e

workdir=~/external/installed-pkgs/pkgs
mkdir -p $workdir

cd $workdir
grep-status -P -e '.*' -a -FStatus 'install ok installed' -n -s Package|xargs touch

export PACKAGES_DIR=$workdir

cd ..

install-pkgs -s --reinstall >pkgs.txt 2>&1 

sites=localhost:9999/debian\ localhost:9999/ubuntu
releases=testing\ unstable\ precise
dists=main\ contrib\ non-free\ universe\ multiverse\ restricted
archs=armel\ i386\ amd64

for site in $sites; do
    for release in $releases; do
	rm $release.txt -f
	for dist in $dists; do
	    for arch in $archs; do
		echo http://$site/dists/$release/$dist/binary-$arch/Packages.gz
	    done
	done
    done
done | mf-download.pl -n 5
	
	
pkgnames=$(cat pkgs.txt|grep -e '^Inst .*Debian:'|pn 2)


for site in $sites; do
    export SITE=$(echo $site| perl -npe 's,.*/,,')
    for release in $releases; do
	for dist in $dists; do
	    for arch in $archs; do
		zcat $site/dists/$release/$dist/binary-$arch/Packages.gz | get-deb-pkg-path $pkgnames | perl -npe 's,mirrors.163.com,localhost:9999,' >> $release.pkgs
	    done
	done
    done
done

(
    for release in $releases; do
	cat $release.pkgs; 
    done
) | grep '^Y: ' | pn 2 | sort -u | mf-download.pl -n 5

mkdir -p debs
rm debs/* >/dev/null 2>&1 || true
echo 'cat *.pkgs | pn 2 | sort -u | xargs -I %s relative-link %s ./debs/'|putclip
