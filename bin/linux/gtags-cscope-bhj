#!/usr/bin/env perl

use Getopt::Long;
use strict;
use String::ShellQuote;

#gtags-cscope-bhj -f cscope.out -d -L -7 beagle-grep.sh

chomp(my $pwd = `pwd`);
$pwd = "$ENV{HOME}/tmp/for-code-reading/$pwd";
while ( not -f "$pwd/GTAGS" and not "$pwd" eq "/") {
    chomp($pwd = `dirname "$pwd"`);
}
if ($pwd eq "/") {
    chomp($pwd = `readlink -f ~/.gtags-dir`)
}
chdir $pwd;

my $lookup_type = substr($ARGV[4], 1);
$_ = $ARGV[5];
(my $lookup_needle, my $lookup_restrict_regexp) = split;

my $start_dir = substr($pwd, length("$ENV{HOME}/tmp/for-code-reading"));
open(my $grep, "-|", "echo $lookup_type$lookup_needle|gtags-cscope");
print "lookup_restrict_regexp is $lookup_restrict_regexp\n" if $lookup_restrict_regexp;

while (<$grep>) {
  chomp();
  s/^>>.*//;
  my $file=$_;
  $file =~ s/ .*//;
  if (not -e "$start_dir/$file") {
    next;
  }
  if ($lookup_restrict_regexp && not m/$lookup_restrict_regexp/i) {
    next;
  }
  print "$_\n";
}
