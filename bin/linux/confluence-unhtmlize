#!/usr/bin/env perl
use strict;

my $html_start = qr({html}<!-- start of code);
my $html_end = qr(^{html}$);

my $code_start = $html_start;
my $code_end = qr(^end of code -->);

while (<>) {
  if (m/$html_start/ .. m/$html_end/) {
    if (m/$code_start/ .. m/$code_end/) {
      my $s = $_;
      $s =~ s/%(..)/chr(eval("0x$1"))/ge;
      unless (m/$code_start/ or m/$code_end/) {
        print $s;
      }
        
    }
  } else {
    print;
  }
}
