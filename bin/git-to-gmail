#!/bin/bash
set -e
ip=`ifconfig |grep -P 'HWaddr .*?$' -o |perl -ne 'print if 1..1'`

for x in "$@"; do

    (
	cd $x
	old_version=`cat .old_version~ 2>/dev/null||true`
	test -z "$old_version" && old_version=master
	if ! test -d .git; then
	    touch .git-to-gmail; git init; git add .git-to-gmail; git commit -m init
	fi
	git add .
	
	if git diff --quiet $old_version; then
	    exit
	fi

	git diff --binary $old_version > .new_config_diff~
	touch .old_config_diff~

	if ! diff .new_config_diff~ .old_config_diff~; then
	    mailx -s "git-to-gmail $x from $ip" -a .new_config_diff~ baohaojun@gmail.com </dev/null
	    mv .new_config_diff~ .old_config_diff~
	    git commit -m 'git-to-gmail auto commit'
	    git log -1|head -n 1|pn 2 > .old_version~
	else
	    echo old and new diff is the same
	fi

    )
done
