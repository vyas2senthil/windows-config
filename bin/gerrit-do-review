#!/bin/bash

rev=${1-HEAD}

function die() {
    echo Error: "$@"
    exit -1
}

repo sync -n .
if ! git-is-ancestor $(repo-remote-branch) $rev; then
    die "Not fast-forward push is not allowed"
fi

gerrit review "$(git rev-parse $rev)" --submit --verified +1 --code-review +2 
if test "$DEBUG"; then
    sleep 1
fi
gerrit-do-review-dependencies $rev

if test -z "$GERRIT_HOST"; then
    (
        cd $(lookup_file .git/..);
        if test -e .gerrit-hooks; then
            echo running the hooks
            bash .gerrit-hooks do-review $rev
        fi
    )
fi

