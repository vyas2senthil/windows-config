#!/bin/bash

if test $# = 0 -o $# = 1 -a -n "$(git rev-parse "$1" 2>/dev/null)"; then
    set -- $(
	if tty >/dev/null 2>&1; then
	    git log -1 "$(git rev-parse $1)"
	else 
	    cat
	fi | grep -P '^\s*Change-Id:' | pn 2) 
fi

(
    for x in "$@"; do
	query_out=$(gerrit query $x)
	url=$(echo "$query_out" | grep -P "^\s*url:" | pn 2 | head -n 1)
	if test -z "$url"; then
	    id=$(echo "$query_out" | grep -P "^\s*number:" | pn 2 | head -n 1)
	    host=$( (repo-review-url $(repo-remote) | perl -npe 's/:.*//') 2>/dev/null )
	    url=$(printf http://%s%s $host $id)
	fi
	of "$url"
	sleep 1;
    done
)
