#!/bin/bash

file=$1
x=0

function find() {
    command find 2>/dev/null "$@"
}

# builtin cd -P . >/dev/null 2>&1

test ! -e "$file" -a "${file:0:7}" = "file://" && file=${file:7}

(
    while true; do

	if [[ "$PWD" =~ ^$HOME/smb/[^/]+$ || "$PWD" =~ ^//[^/]+$ ]]; then
	    if test "$(dirname "$1")" = . && find . -maxdepth 1|grep -q "^./$1$"; then
		break;
	    else
		cd ~
		continue
	    fi
	fi

	test -e "$file" && break

	if test "$PWD" = /; then
	    exit -1
	fi
	builtin cd ..
    done

    if test "${file:0:1}" = /; then
	echo "$file"
    else
	if test -e "$PWD"/"$file"; then
	    echo "$PWD"/"$file"
	else
	    echo "$file"
	fi
    fi
) || (
    dir=`dirname "$file"`
    base=`basename "$file"`

    while true; do
	if find "$dir" -maxdepth 1 -iname "*$base*"|grep -q .; then
	    find "$PWD"/"$dir" -maxdepth 1 -iname "*$base*"
	    exit 0
	fi

	if test "$PWD" = /; then
	    exit -1
	fi

	if [[ "$PWD" =~ ^$HOME/smb/[^/]+$ || "$PWD" =~ ^//[^/]+$ ]]; then
	    if test "$(dirname "$1")" = . && find . -maxdepth 1|grep -q "^./$1$"; then
		break;
	    else
		cd ~
		continue
	    fi
	fi
	builtin cd ..
    done
) || (
    which "$file" 2>/dev/null
) || (
    if [[ "$file" =~ :// ]]; then
	echo "$file"
    else
	readlink -m "$file"
    fi
    exit -1
)
