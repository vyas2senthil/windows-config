#!/bin/bash

if test "$REMOTEIP"; then
   ssh-restricted "$REMOTEIP" gerrit-review-mail-it "$@"
   exit
fi

tmpf=/tmp/$(basename $0).$$
cat > $tmpf

if test $# = 0; then

    title=$(
        cat $tmpf |
        perl -ne 'print if m/^* git commit message/ .. 0' |
        perl -ne 's/^\s*//; print if 7..7'
    )
    title="Review request: $title"

    recipients=$(
        cat $tmpf |
        perl -ne 'print if m/^* git commit message/ .. 0' |
        grep -e 'Reviewed-by:' |
        pn 2 |
        perl -npe 's/\s+//; s/$/\@marvell.com/; print "\n"'
    )

    set -e
    cat $tmpf | mailx -s "$title" $recipients
    echo mail sent.
fi

if test "$1" = build-failed; then
    shift
    set -e
    
    bhj-notify "hourly build $(now)" "failed, last time is $last_time_build_ok"
    last_time_build_ok=$1
    shift

    title=$(echo Automatic hourly build failed $(now) - "$@")
    
    tmpd=~/tmp/$(basename $0).$$.dir
    mkdir -p $tmpd
    cd $tmpd
    tar zxfv $tmpf

    #################################################################
    # in case some one passed a symlink to a passwd file, trying to
    # trick us to mail that file to him!
    find . -type -l | xargs rm >/dev/null 2>&1 || true 
    
    recipients=$(
        find ./daily-changes -type f | xargs cat |
        grep '^Commit:' |
        perl -npe 's/.*<//; s/>.*//;' |
        sort -u;
        echo hjbao@marvell.com
    )

    if test -e ~/.mail-build-errors -a $last_time_build_ok = "last_time_build_ok=yes";
    then
        recipients="-c $recipients"
    else
        recipients=
    fi
    
    set -e
    cp $tmpf commit-messages.tgz
    cat <<EOF | mailx -s "$title" hjbao@marvell.com $recipients -a commit-messages.tgz -a build.log
Hi, all

$recipients

You are receiving this email because the automatic hourly build has
failed, and you are among the people who commited changes in the last
hour.

Please refer to the attached commit-messages.tgz for the details of
your commit.

In the attached build.log, you can find the build fail reason. Here's
a grep which hopefully can show some clue:

$(grep -i -e "\*\*\*.*stop\|no such \|circular.*dropped\|no rule to\|failed\|[0-9]+elapsed \|error [0-9]+\|because of errors\|[0-9]+ error\b\|error:" build.log | perl -npe 's/^/    /')

Sorry for disturbing your work flow, especially so if you are not
responsible for this build error. But let's work together more closely
to improve our quality!

Thanks.

EOF
    
fi
echo mail sent.
