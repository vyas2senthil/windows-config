#!/bin/bash

. ~/.bashrc
build_env=`lookup_file build/envsetup.sh`
top_dir=`dirname $build_env`
top_dir=`readlink -f $top_dir/..`
set -e
jobs=3 #default
TEMP=$(getopt -o j: -n $(basename $0) -- "$@")
function die() {
    echo "$@"
    exit -1
}

eval set -- "$TEMP"
while true; do
    case "$1" in
	-j)
	    jobs=$2
	    shift 2
	    ;;
	--)
	    shift
	    break
	    ;;
	*)
	    die "internal error"
	    ;;
    esac
done

cd $top_dir || exit
. build/envsetup.sh >/dev/null 2>&1

if test $# -gt 2; then
    die "Usage: $(basename "$0") [lunch-combo] [target]"
fi

target=all
if test $# -gt 0; then
    if lunch "$1"; then
	shift
	. ~/bin/.android-set-outdir
	android-set-product
    fi
fi

if test $# -gt 0; then
    target=$1
fi

(set -x; cd $(android-env get_abs_build_var TARGET_OUT) >/dev/null 2>&1 && rm ../system.img ../obj/PACKAGING/systemimage_intermediates/system.img -v) || true
test -e buildspec.mk || { echo no buildspec.mk, will exit now; exit; }

(
    time (
	touch .for-code-reading
	echo 'about to lock at '$(date)
	flock 9 || { echo 'lock failed at '$(date); exit -1; }
	echo 'lock success! at '$(date)
	(
	    echo "before build, ccache stat is $(./prebuilt/linux-x86/ccache/ccache -s)"
	    echo "external dirs not managed by repo: $(repo-external)"
	    echo "changed repos are: $(repo-changes\?)"
	)&
	result=''
	if test "$target" = all; then
	    time $(which time) make -j$jobs -l$jobs -k droid telephony uboot obm && result=$result'all ok; '
	fi
	if [[ "$target" =~ kernel ]]; then
	    command time make -k kernel && result=$result'kernel ok; '
	fi
	
	if [[ "$target" =~ system ]]; then
	    command time make -j$jobs -l$jobs -k && result=$result'android ok; '
	fi
	if [[ "$target" =~ misc ]]; then
	    command time make -k telephony uboot obm && result=$result'misc ok; '
	fi
	echo "$result"
	(
	    cd flashing
	    ./make-links.sh
	    dest=$(android-env get_abs_build_var OUT_DIR)/flashing/
	    mkdir -p $dest
	    DO_SYMLINK=true ./copy-release.sh $dest
	) >/dev/null 2>&1 
	echo -n 'after build, ccache stat is '
	./prebuilt/linux-x86/ccache/ccache -s
    )
) 9>~/.logs/android-full-build.lock  2>&1 | tee build.log
