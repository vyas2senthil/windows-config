#!/bin/bash

. ~/.bashrc
build_env=`lookup_file build/envsetup.sh`
top_dir=`dirname $build_env`
top_dir=`readlink -f $top_dir/..`
set -e
jobs=3 #default
TEMP=$(getopt -o j: -n $(basename $0) -- "$@")
function die() {
    echo "$@"
    exit -1
}

eval set -- "$TEMP"
while true; do
    case "$1" in
	-j)
	    jobs=$2
	    shift 2
	    ;;
	--)
	    shift
	    break
	    ;;
	*)
	    die "internal error"
	    ;;
    esac
done

cd $top_dir || exit
. build/envsetup.sh >/dev/null 2>&1

if test $# -gt 2; then
    die "Usage: $(basename "$0") [lunch-combo] [target]"
fi

target='kernel system misc'
if test $# -gt 0; then
    if lunch "$1"; then
	shift
	android-set-product
    fi
    TARGET_PRODUCT=$(get_build_var TARGET_PRODUCT)
    TARGET_BUILD_VARIANT=$(get_build_var TARGET_BUILD_VARIANT)
    export OUT_DIR_LONG=out-$TARGET_PRODUCT-$TARGET_BUILD_VARIANT
    mkdir -p $OUT_DIR_LONG
    export OUT_DIR=$(echo -n $OUT_DIR_LONG|md5sum|cut -b 1-3)
    if test -e $OUT_DIR -a "$(readlink -m $OUT_DIR)" != "$(readlink -m $OUT_DIR_LONG)"; then
	x=0
	while test -e $OUT_DIR.$x; do
	    ((x++))
	done
	OUT_DIR=$OUT_DIR.$x
    fi
    export OUT_DIR=$OUT_DIR
    relative-link "$OUT_DIR_LONG" "$OUT_DIR"
    rm -rf out target_out_symlink
    ln -s "$OUT_DIR_LONG" out
    ln -s "$OUT_DIR"/target/product/$TARGET_PRODUCT target_out_symlink

fi

if test $# -gt 0; then
    target=$1
fi

(set -x; cd $(android-env get_abs_build_var TARGET_OUT) >/dev/null 2>&1 && rm ../system.img ../obj/PACKAGING/systemimage_intermediates/system.img -v) || true
test -e buildspec.mk || { echo no buildspec.mk, will exit now; exit; }

(
    touch .for-code-reading
    echo 'about to lock at '$(date)
    flock 9 || { echo 'lock failed at'$(date); exit -1; }
    echo 'lock success! at'$(date)
    (
	echo "before build, ccache size is $(du -s -h ~/.ccache/)"
	echo "external dirs not managed by repo: $(repo-external)"
    )&
    result=''
    if [[ "$target" =~ kernel ]]; then
	command time make kernel && result=$result'kernel ok; '
    fi
    
    if [[ "$target" =~ system ]]; then
	command time make -j$jobs -l$jobs -k && result=$result'android ok; '
    fi
    if [[ "$target" =~ misc ]]; then
	command time make telephony uboot obm && result=$result'misc ok; '
    fi
    echo "$result"
    echo -n 'after build, ccache size is '
    du -s -h ~/.ccache/
) 9>~/.logs/android-full-build.lock  2>&1 | tee build.log
