#!/bin/bash

. ~/.bashrc
build_env=`lookup_file build/envsetup.sh`
top_dir=`dirname $build_env`
top_dir=`readlink -f $top_dir/..`

cd $top_dir || exit
. build/envsetup.sh >/dev/null 2>&1

(cd $(android-env get_abs_build_var TARGET_OUT) >/dev/null 2>&1 && rm ../system.img ../obj/PACKAGING/systemimage_intermediates/system.img -v)
test -e buildspec.mk || { echo no buildspec.mk, will exit now; exit; }

(
    echo 'about to lock at '$(date)
    flock 9 || { echo 'lock failed at'$(date); exit -1; }
    echo 'lock success! at'$(date)
    echo external dirs not managed by repo:
    repo-external
    result=''
    command time make kernel && result=$result'kernel ok; '
    command time make -j${1:-3} -l${1:-3} -k && result=$result'android ok; '
    command time make telephony uboot obm && result=$result'misc ok; '
    echo "$result"
) 9>~/.logs/android-full-build.lock  2>&1 | tee build.log
