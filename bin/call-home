#! /bin/bash

if test -e ~/.at-home; then
    exit 0
fi

if test "$USER" != bhj; then
    echo Should not start ssh because you are not bao haojun
    exit 0
fi

(
    flock -n 9 || { echo 'lock failed at '$(date); exit 0; }
    while true; do
        if test -e ~/.at-home; then
            exit 0
        fi
	ssh -C2qN -D 18080 -R :$(printf %d 0x2$(from-mac|sha1sum|cut -b 1-3)):localhost:22 bhj.is-a-geek.org -p 443
	x=30
	y=$(random 30)
	((x = x + y))
	sleep $x
    done
) 9>~/.logs/$(basename $0).lock  2>&1 &

(
    flock -n 9 || { echo 'lock failed at '$(date); exit 0; }
    if test -e ~/.at-home; then
        exit 0
    fi
    while true; do
        tsocks ssh -C2qN -D 38080 bhj@fixnet
	x=30
	y=$(random 30)
	((x = x + y))
	sleep $x
    done
) 9>~/.logs/$(basename $0).lock-fix-net  2>&1 &

if nmcli con status id vpn-home |grep 'VPN connected'; then
    sudo route add -net 10.0.0.0 netmask 255.0.0.0 gw 10.21.130.1
else
    sudo su - -c 'nmcli con up id vpn-home'
    sudo route add -net 10.0.0.0 netmask 255.0.0.0 gw 10.21.130.1
fi || true
