#!/bin/bash
set -e

tf=/tmp/org-export-$$ # temp file
(
    if grep -e '^#+title:' -i "$1" -q; then
	true;
    else
	title=$(echo "$1" | perl -npe 's/_/\\_/g;')
    cat <<EOF
#+TITLE: ${title/%.org/}
EOF
    fi

    if test $# = 1; then
	cat "$1"
    else
	perl -ne '
BEGIN {
    $start = 0; 
}
if (m/^\*.*'"$2"'/) {
    $start = 1;
}

if (m/^\*/ and $_ !~ m/'"$2"'/) {
    exit;
}

print if $start;
' < "$1"
    fi
) > $tf.org

(cd $(dirname $tf.org)
	emacs-nt -Q --batch \
	    --eval "$(org-export.help $(basename $tf.org))"
)


perl -npe 's,\bfile:////([^/]),file://///$1,g' -i $tf.html
cp $tf.html "$1".html
of "$1".html
rm $tf.* 
