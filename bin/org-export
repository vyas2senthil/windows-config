#!/bin/bash
set -e

if test $# = 0; then
    die "Error: Usage $(basename $0) FILE.org"
fi

export ORG_FILE_NAME=$(readlink -f $1);
test -e $1
tf=/tmp/org-export-$$ # temp file
(
    if grep -e '^#+title:' -i "$1" -q; then
	true;
    else
	title=$(echo "$1" | perl -npe 's/_/\\_/g;')
    cat <<EOF
#+TITLE: ${title/%.org/}
EOF
    fi

    if test $# = 1; then
	cat "$1"
    else
	perl -ne ' # I am not sure what does this mean anymore.
BEGIN {
    $start = 0; 
}
if (m/^\*.*'"$2"'/) {
    $start = 1;
}

if (m/^\*/ and $_ !~ m/'"$2"'/) {
    exit;
}

print if $start;
' < "$1"
    fi
) > $tf.org

(cd $(dirname $tf.org)
	emacs-nt -q --batch \
	    --eval "$(org-export.help $(basename $tf.org))"
)


perl -npe 's,\bfile:////([^/]),file://///$1,g' -i $tf.html
if test -e "$(dirname "$1")"/.no-org.html; then
    set -- "${1%.org}"
fi
cp $tf.html "$1".html
of "$1".html
rm $tf.* 
