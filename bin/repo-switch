#!/bin/bash
set -e

repodir=$(lookup_file -e .repo)
if test -z "$repodir"; then
    repo init "$@"
    exit
fi

cd "$repodir"
test -d manifests

cp -av $(readlink -f manifest.xml) manifest.xml.old || true
rm manifest.xml || true

mkdir -p local_manifests/
if test -e local_manifests/local_manifist.xml; then
    mv local_manifests/local_manifist.xml local_manifests/local_manifist.xml.2
fi

cd manifests
git co HEAD^
for x in `git branch|grep -v '^\*'`; do git branch -D $x; done

repo init "$@"

cd ..

if test -x repo-init-hook; then
    ./repo-init-hook
fi

if test -e local_manifests/local_manifist.xml.2; then
    mv -v local_manifests/local_manifist.xml.2 local_manifests/local_manifist.xml
fi

(
    printf 'repo-switch'
    for x in "$@"; do 
        printf ' %q' "$x";
    done
) > repo-switch

if ! diff -q manifest.xml manifest.xml.old; then
    touch .need_rebuild
fi

echo ok.
