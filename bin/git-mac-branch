#!/bin/bash
set -e

if test -e ~/.git-mac-no; then
    if tty >/dev/null 2>&1; then
	rm ~/.git-mac-no
    else
	exit
    fi
fi
cd ${1:-~/windows-config}

if git status -s|
    pn 2|
    xargs -I %s stat -c %Y %s|
    perl -ne '
chomp; 
$time = $time < $_ ? $_ : $time; 
END{
    use POSIX; 
    print "time is $time\n";
    if (time() - $time > 3600) {
        exit(0);
    } else {
        exit(-1);
    }
}'; then
    echo 'your changes are made 1 hour ago, should commit now'
else
    if tty >/dev/null 2>&1; then
	echo commiting even though you made changes only recently, as you wish
    else
	. ~/.new-xauth
	 notify-send git-mac-branch "not commiting because you made changes only recently, and we are not on any console"
	exit
    fi
fi

git add . 
git commit -m mf ||true
rb=from-mac/`ifconfig|grep HWaddr|head -n 1|perl -npe 's/.*HWaddr //; s/:/-/g; s/\s//g;'`-`hostname`
git diff --quiet origin/$rb || git push origin HEAD:$rb
