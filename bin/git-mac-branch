#!/bin/bash
set -e

hold_up=1
if test -e ~/.git-mac-no; then
    if tty >/dev/null 2>&1; then
	rm ~/.git-mac-no
    else
	exec </dev/null
	hold_up=5
    fi
fi
cd ${1:-~/windows-config}

if git status -s|
    pn 2|
    xargs -I %s stat -c %Y %s|
    perl -ne '
chomp; 
$time = $time < $_ ? $_ : $time; 
END{
    use POSIX; 
    print "time is $time\n";
    if (time() - $time > '$hold_up' * 3600) {
        exit(0);
    } else {
        exit(-1);
    }
}'; then
    echo "your changes are made $hold_up hour ago, should commit now"
else
    if tty >/dev/null 2>&1; then
	echo commiting even though you made changes only recently, as you wish
    else
	if test $(date +%H) -gt 20; then #if it's late in the night, we may be at home, so lets reminder it
	    bhj-notify git-mac-branch "not commiting because you made changes only recently, and we are not on any console"
	fi
	exit
    fi
fi

git add . 
git commit -m mf ||true
rb=from-mac/`ifconfig|grep HWaddr|head -n 1|perl -npe 's/.*HWaddr //; s/:/-/g; s/\s//g;'`-`hostname`
git diff --quiet origin/$rb || git push origin HEAD:$rb
