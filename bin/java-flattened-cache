#!/bin/bash

function die() {
    echo Error: "$@"
    exit -1
}

if test $# != 1; then
    die "Error: Usage $(basename $0) file"
fi


file=$1
cache=$HOME/tmp/code-reading-flattern$PWD/$file
def=$HOME/tmp/code-reading-defs$PWD/$file
if test ! -e $cache -o $cache -ot $file; then
    mkdir -p $(dirname $cache) $(dirname $def)    
    flattern.pl $file > $cache
    (
        cd $HOME/tmp/code-reading-flattern$PWD
        grep-imenu -e '.*' -f $file
    ) > $def
fi

if test $(basename $0) = java-flattened-cache; then
    echo $cache;
elif test $(basename $0) = java-tags-cache; then
    echo $def
fi
