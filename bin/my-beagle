#!/bin/bash
start_dir=~/tmp/for-code-reading/`pwd`
# echo Starting at $start_dir 1>&2
while test ! -d "$start_dir"/.beagle -a "$start_dir" != /
do
    start_dir=${start_dir%/*}
done

if test "$start_dir" = / -o "$start_dir" = $HOME
then
    start_dir=`readlink -f ~/.gtags-dir`
fi

beagle_dir=$start_dir/.beagle
# echo Beagle index found at "$beagle_dir" 1>&2

if test -f "$start_dir"/.beagle-filter
then
    beagle_filter="$start_dir"/.beagle-filter
else
    echo 'Warning: you have no .beagle-filter at $start_dir! You will probablly see lots of noise' 1>&2
    beagle_filter=cat
fi

longest_token=`get_longest_token "$@"`
for x in "$beagle_dir" `cat $beagle_dir/../.beagle-brothers 2>/dev/null`
do 
    beagle-static-query \
        --add-static-backend "$x" \
        --backend none --max-hits 100000 "$longest_token" | \
        unurl.pl|grep -v '#'|sort -u|$beagle_filter
done
echo /dev/null
