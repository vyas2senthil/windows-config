#!/bin/bash

lcd()
{
    if test $# != 1; then
        return 1
    elif test "$1" = -; then
        cd_ok -
        return 0
    elif test "$1" = .beagle; then
        cd_beagle;
        return 0;
    fi
    

    if [[ "$1" =~ ^\\\\|^//|^smb:// && `uname` = Linux ]]; then
        chmod 600 ~/.smb/*
        if smbnetfs -o allow_root ~/smb 2>&1|grep -v "mountpoint is not empty\|'nonempty' mount option\|gnome-keyring is not available"|grep -q . ; then
	    sudo umount -l ~/smb
	    smbnetfs -o allow_root ~/smb 2>&1|grep -v "mountpoint is not empty\|'nonempty' mount option\|gnome-keyring is not available"
	fi
        builtin cd ~/smb/"$(host-hosts "$1")"
        history -s cd "$(printf %q "`pwd`")"
        history -s cd "$(printf %q "$1")"
        return 0
    fi
   
    local ori=$1
    local start=$PWD
    local looking=$PWD
    local x=0
    while ! test -e "$1" >/dev/null || { [[ "$looking" =~ ^$HOME/smb(/[^/]+)?$ ]] && test "$looking" != "$start"; }; do # [[..]] because test -e not work in smbnetfs top levels
        set -- ../"$1";
	looking=`dirname "$looking"`
	test "$looking" = / && break
    done

    if ! test -e "$1" >/dev/null; then
        _ucd $ori
        return $?
    fi

    link=$1
    if test -f "$link" && echo "${link##*.}"|grep -i '^lnk$' -q; then 
            link=`readshortcut "$link"`
    fi
    if test -d "$link"; then
        if test "$link" = "`pwd`"; then
            return 1;
        fi
        builtin cd "$link"
        cd_record
        return $?
    elif test -L "$link" -a -f "$link"; then
        builtin cd "$(dirname "$(readlink -f "$link")")"
        cd_record
        return $?
    else
        builtin cd "$(dirname "$link")"
        cd_record
        return $?
    fi
}

_ucd() #we go to upper dir which match the $1, for ex, cd 'ho' in /home/bhj will go to /home, 
{
    local x=0
    dir=`dirname "$(pwd)"`
    dir_basename=`basename "$dir"`
    while ! echo $dir_basename|grep -e $1 -i -q && ((x++ < 10)); do
        dir=`dirname "$dir"`
        dir_basename=`basename "$dir"`
	if test x"$dir" = x/; then
	    break
	fi
    done
    if test x"$dir" = x/; then #obviously, we very not likely want to go to / with this complex setup
        return 1;
    fi
    builtin cd "$dir"
    cd_record
    return $?
}

svn-info-clip()
{
    svn info "$1" |grep '^URL:'|sed -e 's/^URL: //; s/^https/http/'|tr -d '\r\n' | putclip
}

alias for-code-reading='for-code-reading -i -v'

