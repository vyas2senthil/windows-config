#!/bin/bash

. /etc/bash_completion
. ~/.bash_netcompletion

function cd_bhj () {
    lcd "$@" && return $?
    builtin cd -P "$@" >/dev/null 2>&1 || cd_failed "$@"
    (flock -x ~/.where.lock -c where&)
}

function cd_failed() {
    local IFS=$'\n'
    dirs=( $(where "$@") )
    if test ${#dirs[@]} = 0; then
        echo 'Error: no such file or directory'
        return 1
    elif test ${#dirs[@]} = 1; then
        builtin cd ${dirs[0]}
    else 
        select dir in ${dirs[@]}; do builtin cd $dir; history -s cd $dir; break; done
    fi
}

alias cd=cd_bhj
