#!/bin/bash

. /etc/bash_completion
. ~/.bash_netcompletion

function cd_bhj () 
{
    lcd "$@" && return $?
    test $# == 1 -o $# == 0 && builtin cd -P "$@" >/dev/null 2>&1 || cd_failed "$@"
    (flock -x ~/.where.lock -c where&)
}

function my_select() 
{
    local y=1
    for x in "$@"; do 
        echo $y\) "$x" >/dev/tty;
        ((y++))
    done

    read -p "#?" NUM
    if [[ x"$NUM" = x || ! "$NUM" =~ ^[1-9][0-9]*$ ]] || (( "$NUM" > $# )); then
        NUM=1
    fi
    echo $NUM
}

function cd_failed() 
{
    local IFS=$'\n'
    dirs=( $(where "$@") )
    if test ${#dirs[@]} = 0; then
        echo 'Error: no such file or directory'
        return 1
    elif test ${#dirs[@]} = 1; then
        builtin cd ${dirs[0]}
    else 
        NUM=`my_select "${dirs[@]}"`
        ((NUM--))
        builtin cd "${dirs[$NUM]}"
        history -s cd "${dirs[$NUM]}"
        history -s cd "$@"
    fi
}

alias cd=cd_bhj
